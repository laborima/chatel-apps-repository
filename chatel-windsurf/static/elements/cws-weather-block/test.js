define(["underscore","resthub","moment","highcharts","meta-helper","home/js/collections/marees","home/js/model/lieu","home/js/model/lieu-avec-parent","home/js/collections/lieux-marees","hbs!home/template/maree-tmpl","i18n!nls/messages","moment-fr","jquery-datepicker-fr"],function(e,t,i,s,n,o,a,r,l,h,c){var d=t.View.extend({events:{"change select#fsearch-attr-port":"selectLocation","change select#fsearch-attr-mer":"loadList2","change input#fsearch-attr-datepicker":"changeDate","click .link-day.prev":"changeDate","click .link-day.next":"changeDate","click input[name='searchMaree']":"getData"},dateDisplayFormat:"dddd DD MMMM YYYY",initialize:function(e){this.idStation=e.idStation,this.libelleStation=e.libelleStation,this.secondLocations=Portlet.secondLocationList,this.$("select#fsearch-attr-mer").customSelect(),this.$("select#fsearch-attr-port").customSelect(),this.currentDate=i(),"label"===this.$("select#fsearch-attr-port option:selected").val()&&this.$("input#fsearch-attr-datepicker, input#fsearch-attr-date, input#searchMareeButton").prop("disabled",!0),this.updateDateAndLocationDisplay(),this.chartData=[[0,0]],this.renderChart(),"undefined"!=typeof this.idStation&&"undefined"!=typeof this.libelleStation&&""!==this.idStation&&""!==this.libelleStation?this.initLocation():(n.generateMeta("France"),this.previousStationName="France")
},initLocation:function(){this.station=new r,"marine"===Portlet.configuration.type?(this.station.on("change",this.initSelectMarine,this),this.station.fetch({typeCarte:"cotes",type:"PORT_FRANCE",id:this.idStation})):"plages"===Portlet.configuration.type&&(this.station.on("change",this.getGrandFather,this),this.station.fetch({typeCarte:"plages",type:"PLAGE_FRANCE",id:this.idStation}))
},getGrandFather:function(){this.stationFather=new r,this.stationFather.on("change",this.initSelectPlages,this),this.stationFather.fetch({typeCarte:"plages",type:"DEPT_FRANCE",id:this.station.get("parent").id})
	
},initSelectMarine:function(){this.$("select#fsearch-attr-mer").val(this.station.get("parent").id).change(),this.$("select#fsearch-attr-port").val(this.station.get("id")).change(),this.getData()
},initSelectPlages:function(){this.$("select#fsearch-attr-mer").val(this.stationFather.get("parent").id).change()},getData:function(){return this.updateDateAndLocationDisplay(),this.currentLocation&&(this.marees=new o,this.marees.fetch({port:this.currentLocation.get("slug"),date:this.$("input#fsearch-attr-date").val()},{success:e.bind(this.renderData,this),error:e.bind(this.renderNoData,this)})),!1
},renderData:function(){var e=new o;
this.chartData=[];

for(var t=0,s=this.marees.length;s>t;t++){
	var n=i(this.marees.at(t).get("time"),"YYYYMMDDHHmm");
       n.isSame(this.currentDate,"day")&&e.add(this.marees.at(t)),this.chartData.push([parseInt(n.valueOf(),10),this.marees.at(t).get("height")])
}this.$("table#maree tbody").html(h(e.toJSON())),this.renderChart()},renderNoData:function(){this.$("table#maree tbody").html(h(this.marees.toJSON())),this.chartData=[],this.chartData.push([0,0]),this.renderChart()
},loadList2:function(e){var t=$(e.currentTarget).children("option:selected");
this.$("select#fsearch-attr-port option:first-child").attr("selected","selected"),this.$("select#fsearch-attr-port").change(),this.fillList2(t.data("type"),t.val())
},fillList2:function(t,i){var s=this.$("select#fsearch-attr-port");
s.html(""),s.append("<option value='label'>"+c.horairesMarees["select-horaires-"+Portlet.configuration.type]+"</option>"),e.each(this.secondLocations.sort(function(e,t){return e.nomAffiche>t.nomAffiche
}),function(e){e.parent.id===i&&s.append(["<option value='",e.id,"' data-type='",e.type,"' data-slug='",e.slug,"' data-lastmareedate='",e.lastMareeDate,"'>",e.nomAffiche,"</option>"].join(""))
},this)},selectLocation:function(){var e=this.$("select#fsearch-attr-port option:selected"),t=e.val();
"label"!==t?(this.currentLocation=new a({id:e.val(),type:e.data("type"),slug:e.data("slug"),nomAffiche:e.html()}),n.generateMeta(this.currentLocation.get("nomAffiche"),this.previousStationName),this.previousStationName=this.currentLocation.get("nomAffiche"),Backbone.history.navigate(this.currentLocation.get("slug")+"/"+this.currentLocation.get("id").toLowerCase(),!1),this.minDate=i().years(2015).months(0).date(1),this.maxDate=i(new String(e.data("lastmareedate")),["YYYYMMDDHHmm"]),this.$("input#fsearch-attr-datepicker").datepicker({showAnim:"fadeIn",changeMonth:!0,changeYear:!0,minDate:this.minDate.format(this.dateDisplayFormat),maxDate:this.maxDate.format(this.dateDisplayFormat),defaultDate:this.currentDate.format(this.dateDisplayFormat),dateFormat:"DD d MM yy",altField:"input#fsearch-attr-date",altFormat:"yymmdd",monthNamesShort:["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"]}),this.$("input#fsearch-attr-datepicker").val(this.currentDate.format(this.dateDisplayFormat)),this.$("input#fsearch-attr-date").val(this.currentDate.format("YYYYMMDD")),this.$("input#fsearch-attr-datepicker, input#fsearch-attr-date, input#searchMareeButton").prop("disabled",!1)):this.currentLocation=null
},changeDate:function(e){var t=this.$(e.currentTarget);
return t.hasClass("prev")?this.currentDate.isSame(this.minDate,"day")||(this.currentDate.subtract("days",1),this.updateDate(),this.getData()):t.hasClass("next")?this.currentDate.isSame(this.maxDate,"day")||(this.currentDate.add("days",1),this.updateDate(),this.getData()):this.currentDate=i(this.$("input#fsearch-attr-date").val(),"YYYYMMDD"),!1
},updateDateAndLocationDisplay:function(){var e=this.currentDate.format(this.dateDisplayFormat);
this.currentLocation&&(e+=", "+this.currentLocation.get("nomAffiche"),this.$(".mod-caracteristiques-maree-section-resultat .section-header h3").html(e))
},capitalize:function(e){return e.charAt(0).toUpperCase()+e.substring(1).toLowerCase()},updateDate:function(){this.$("input#fsearch-attr-date").val(this.currentDate.format("YYYYMMDD")),this.$("input#fsearch-attr-datepicker").val(this.currentDate.format(this.dateDisplayFormat))
},renderChart:function(){var e=parseInt(i(this.currentDate,"YYYYMMDDHHmm").hours(0).minutes(0).valueOf(),10);
this.chart=new s.Chart({chart:{renderTo:"graphMultipleAxes",type:"spline",width:322,style:{margin:"0 auto"}},title:{text:""},subtitle:{text:""},credits:{enabled:!1},xAxis:{title:{enabled:!0,text:"Heures",style:{color:"#434343",fontSize:"10px",fontWeight:"normal",fontStyle:"italic"}},labels:{formatter:function(){return i(this.value).format("H")
}},min:e-36e5,max:e+9e7,tickInterval:72e5,lineWidth:1,lineColor:"#353535",gridLineWidth:1,showLastLabel:!0,gridLineColor:"#dadada"},yAxis:{title:{text:"Hauteur en mètres",style:{color:"#434343",fontSize:"10px",fontWeight:"normal",fontStyle:"italic"}},labels:{formatter:function(){return this.value
}},labelsColor:"#ff0000",max:this.maxHeight,min:0,lineWidth:1,lineColor:"#353535",tickInterval:1,showLastLabel:!0,gridLineWidth:1,gridLineColor:"#dadada"},legend:{enabled:!1,itemStyle:{color:"#000000"}},exporting:{enabled:!1},tooltip:{formatter:function(){return i(this.x).format("HH[h]mm")+" <br/>"+this.y+"m"
},style:{textAlign:"center"}},plotOptions:{spline:{marker:{enable:!1}}},series:[{name:"Temperature",color:"#807f80",data:this.chartData}]})}});
return d});
;
